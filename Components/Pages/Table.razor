@page "/table"

<PageTitle>Table</PageTitle>

<h1>Table</h1>

<p>Three-level QuickGrid table with 100 generated rows per nested level.</p>

<table class="table table-striped table-hover mb-0" data-testid="level1-table">
    <thead>
        <tr>
            <th></th>
            <th>ID</th>
            <th>Name</th>
            <th>Role</th>
            <th>Active</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var row in Rows)
        {
            <tr data-testid="@($"level1-row-{row.Id}")">
                <td>
                    <button class="btn btn-sm btn-outline-secondary expand-btn"
                            data-testid="@($"level1-toggle-{row.Id}")"
                            @onclick="() => ToggleParentTable(row.Id)">
                        @(IsParentExpanded(row.Id) ? "-" : "+")
                    </button>
                </td>
                <td>@row.Id</td>
                <td>@row.Name</td>
                <td>@row.Role</td>
                <td>@(row.IsActive ? "Yes" : "No")</td>
            </tr>

            @if (IsParentExpanded(row.Id))
            {
                <tr class="level2-host-row" data-testid="@($"level2-host-{row.Id}")">
                    <td colspan="5">
                        <table class="table table-sm mb-0 nested-grid nested-table" data-testid="@($"level2-table-{row.Id}")">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Sub ID</th>
                                    <th>Component</th>
                                    <th>Status</th>
                                    <th>Owner</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var subRow in GetSubRows(row.Id))
                                {
                                    <tr data-testid="@($"level2-row-{row.Id}-{subRow.Id}")">
                                        <td>
                                            <button class="btn btn-sm btn-outline-secondary expand-btn"
                                                    data-testid="@($"level2-toggle-{row.Id}-{subRow.Id}")"
                                                    @onclick="() => ToggleChildTable(row.Id, subRow.Id)">
                                                @(IsChildExpanded(row.Id, subRow.Id) ? "-" : "+")
                                            </button>
                                        </td>
                                        <td>@subRow.Id</td>
                                        <td>@subRow.Component</td>
                                        <td>@subRow.Status</td>
                                        <td>@subRow.Owner</td>
                                    </tr>

                                    @if (IsChildExpanded(row.Id, subRow.Id))
                                    {
                                        <tr class="level3-host-row" data-testid="@($"level3-host-{row.Id}-{subRow.Id}")">
                                            <td colspan="5">
                                                <table class="table table-sm mb-0 nested-grid nested-grid-level-3 nested-table"
                                                       data-testid="@($"level3-table-{row.Id}-{subRow.Id}")">
                                                    <thead>
                                                        <tr>
                                                            <th>Detail ID</th>
                                                            <th>Metric</th>
                                                            <th>Value</th>
                                                            <th>Updated By</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var detail in GetDetailRows(row.Id, subRow.Id))
                                                        {
                                                            <tr>
                                                                <td>@detail.Id</td>
                                                                <td>@detail.Metric</td>
                                                                <td>@detail.Value</td>
                                                                <td>@detail.UpdatedBy</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@code {
    private int? expandedParentId;
    private ChildRowKey? expandedChildKey;
    private static readonly string[] Roles = ["Admin", "Editor", "Viewer", "Reviewer"];
    private static readonly string[] Statuses = ["Healthy", "Warning", "Offline"];
    private static readonly string[] Owners = ["Alex", "Sam", "Taylor", "Jordan"];

    private static readonly IReadOnlyList<TableRow> Rows = Enumerable.Range(1, 100)
        .Select(id => new TableRow(
            id,
            $"User {id:000}",
            Roles[(id - 1) % Roles.Length],
            id % 2 == 0))
        .ToList();

    private IEnumerable<TableSubRow> GetSubRows(int parentId) =>
        Enumerable.Range(1, 100)
            .Select(id => new TableSubRow(
                id,
                $"P{parentId:000}-Component-{id:000}",
                Statuses[(parentId + id) % Statuses.Length],
                Owners[(id - 1) % Owners.Length]));

    private IEnumerable<TableDetailRow> GetDetailRows(int parentId, int childId) =>
        Enumerable.Range(1, 100)
            .Select(id => new TableDetailRow(
                id,
                $"P{parentId:000}-C{childId:000}-Metric-{id:000}",
                $"{((parentId * childId * id) % 100) + 1}%",
                Owners[(parentId + childId + id) % Owners.Length]));

    private void ToggleParentTable(int rowId)
    {
        expandedParentId = expandedParentId == rowId ? null : rowId;
        expandedChildKey = null;
    }

    private void ToggleChildTable(int parentId, int childId)
    {
        var key = new ChildRowKey(parentId, childId);
        expandedChildKey = expandedChildKey == key ? null : key;
    }

    private bool IsParentExpanded(int rowId) => expandedParentId == rowId;
    private bool IsChildExpanded(int parentId, int childId) => expandedChildKey == new ChildRowKey(parentId, childId);

    private sealed record ChildRowKey(int ParentId, int ChildId);

    private sealed record TableRow(int Id, string Name, string Role, bool IsActive);

    private sealed record TableSubRow(int Id, string Component, string Status, string Owner);

    private sealed record TableDetailRow(int Id, string Metric, string Value, string UpdatedBy);
}
