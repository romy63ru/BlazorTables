@page "/table"
@using Microsoft.AspNetCore.Components.QuickGrid

<PageTitle>Table</PageTitle>

<h1>Table</h1>

<p>3-level nested QuickGrid with 100 generated root rows and 10 columns.</p>

<QuickGrid Items="RootRows.AsQueryable()" Class="table table-striped table-hover align-middle">
    <TemplateColumn Title="ID" Context="row">
        @if (row.Children.Count > 0)
        {
            <button type="button"
                    class="btn btn-sm btn-outline-secondary me-2"
                    title="Expand level 2 rows"
                    @onclick="() => Toggle(expandedLevel1, row.Id)">
                @(expandedLevel1.Contains(row.Id) ? "-" : "+")
            </button>
        }
        @row.Id

        @if (expandedLevel1.Contains(row.Id) && row.Children.Count > 0)
        {
            <div class="mt-2 ms-3">
                <QuickGrid Items="row.Children.AsQueryable()" Class="table table-sm table-bordered align-middle mb-0">
                    <TemplateColumn Title="ID" Context="child">
                        @if (child.Children.Count > 0)
                        {
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary me-2"
                                    title="Expand level 3 rows"
                                    @onclick="() => Toggle(expandedLevel2, child.Id)">
                                @(expandedLevel2.Contains(child.Id) ? "-" : "+")
                            </button>
                        }
                        @child.Id

                        @if (expandedLevel2.Contains(child.Id) && child.Children.Count > 0)
                        {
                            <div class="mt-2 ms-3">
                                <QuickGrid Items="child.Children.AsQueryable()" Class="table table-sm mb-0 align-middle">
                                    <PropertyColumn Property="grandChild => grandChild.Id" Title="ID" />
                                    <PropertyColumn Property="grandChild => grandChild.Level" Title="Level" />
                                    <TemplateColumn Title="Parent ID" Context="grandChild">
                                        @(grandChild.ParentId?.ToString() ?? "-")
                                    </TemplateColumn>
                                    <PropertyColumn Property="grandChild => grandChild.Number" Title="Number" />
                                    <PropertyColumn Property="grandChild => grandChild.Test" Title="Test" />
                                    <PropertyColumn Property="grandChild => grandChild.Code" Title="Code" />
                                    <PropertyColumn Property="grandChild => grandChild.Description" Title="Description" />
                                    <TemplateColumn Title="Created Date" Context="grandChild">
                                        @grandChild.CreatedDate.ToString("yyyy-MM-dd")
                                    </TemplateColumn>
                                    <TemplateColumn Title="Amount" Context="grandChild">
                                        @grandChild.Amount.ToString("F2")
                                    </TemplateColumn>
                                    <TemplateColumn Title="Checked" Context="grandChild">
                                        <input type="checkbox" checked="@grandChild.IsChecked" disabled />
                                    </TemplateColumn>
                                </QuickGrid>
                            </div>
                        }
                    </TemplateColumn>
                    <PropertyColumn Property="child => child.Level" Title="Level" />
                    <TemplateColumn Title="Parent ID" Context="child">
                        @(child.ParentId?.ToString() ?? "-")
                    </TemplateColumn>
                    <PropertyColumn Property="child => child.Number" Title="Number" />
                    <PropertyColumn Property="child => child.Test" Title="Test" />
                    <PropertyColumn Property="child => child.Code" Title="Code" />
                    <PropertyColumn Property="child => child.Description" Title="Description" />
                    <TemplateColumn Title="Created Date" Context="child">
                        @child.CreatedDate.ToString("yyyy-MM-dd")
                    </TemplateColumn>
                    <TemplateColumn Title="Amount" Context="child">
                        @child.Amount.ToString("F2")
                    </TemplateColumn>
                    <TemplateColumn Title="Checked" Context="child">
                        <input type="checkbox" checked="@child.IsChecked" disabled />
                    </TemplateColumn>
                </QuickGrid>
            </div>
        }
    </TemplateColumn>
    <PropertyColumn Property="row => row.Level" Title="Level" />
    <TemplateColumn Title="Parent ID" Context="row">
        @(row.ParentId?.ToString() ?? "-")
    </TemplateColumn>
    <PropertyColumn Property="row => row.Number" Title="Number" />
    <PropertyColumn Property="row => row.Test" Title="Test" />
    <PropertyColumn Property="row => row.Code" Title="Code" />
    <PropertyColumn Property="row => row.Description" Title="Description" />
    <TemplateColumn Title="Created Date" Context="row">
        @row.CreatedDate.ToString("yyyy-MM-dd")
    </TemplateColumn>
    <TemplateColumn Title="Amount" Context="row">
        @row.Amount.ToString("F2")
    </TemplateColumn>
    <TemplateColumn Title="Checked" Context="row">
        <input type="checkbox" checked="@row.IsChecked" disabled />
    </TemplateColumn>
</QuickGrid>

@code {
    private static readonly IReadOnlyList<TableRow> RootRows = BuildRows();
    private readonly HashSet<int> expandedLevel1 = [];
    private readonly HashSet<int> expandedLevel2 = [];

    private void Toggle(HashSet<int> expandedRows, int rowId)
    {
        if (!expandedRows.Add(rowId))
        {
            expandedRows.Remove(rowId);
        }
    }

    private static IReadOnlyList<TableRow> BuildRows()
    {
        var random = new Random(20260206);
        var nextId = 1;
        var rows = new List<TableRow>(capacity: 100);

        for (var i = 1; i <= 100; i++)
        {
            var topRowId = nextId++;
            var level2Rows = new List<TableRow>(capacity: 2);

            for (var j = 1; j <= 2; j++)
            {
                var level2Id = nextId++;
                var level3Rows = new List<TableRow>(capacity: 2);

                for (var k = 1; k <= 2; k++)
                {
                    var level3Id = nextId++;
                    level3Rows.Add(CreateRow(level3Id, 3, level2Id, $"L3-{i:D3}-{j:D2}-{k:D2}", random));
                }

                level2Rows.Add(CreateRow(level2Id, 2, topRowId, $"L2-{i:D3}-{j:D2}", random, level3Rows));
            }

            rows.Add(CreateRow(topRowId, 1, null, $"L1-{i:D3}", random, level2Rows));
        }

        return rows;
    }

    private static TableRow CreateRow(
        int id,
        int level,
        int? parentId,
        string code,
        Random random,
        IReadOnlyList<TableRow>? children = null)
    {
        var createdDate = DateOnly.FromDateTime(DateTime.Today.AddDays(-random.Next(0, 365)));

        return new TableRow(
            id,
            level,
            parentId,
            random.Next(1000, 9999),
            $"Test {id}",
            code,
            $"Generated row {id}",
            createdDate,
            Math.Round(random.NextDouble() * 1000, 2),
            random.Next(0, 2) == 1,
            children ?? []);
    }

    private sealed record TableRow(
        int Id,
        int Level,
        int? ParentId,
        int Number,
        string Test,
        string Code,
        string Description,
        DateOnly CreatedDate,
        double Amount,
        bool IsChecked,
        IReadOnlyList<TableRow> Children);
}
