@page "/table"

<PageTitle>Table</PageTitle>

<h1>Table</h1>

<p>Three-level QuickGrid table with 100 generated rows per nested level.</p>

<QuickGrid Items="Rows" Class="table table-striped table-hover" Pagination="Pagination">
    <TemplateColumn Title="" Context="row">
        <button class="btn btn-sm btn-outline-secondary expand-btn" @onclick="() => ToggleParentTable(row.Id)">
            @(IsParentExpanded(row.Id) ? "-" : "+")
        </button>
    </TemplateColumn>
    <PropertyColumn Property="row => row.Id" Title="ID" Sortable="true" />
    <PropertyColumn Property="row => row.Name" Title="Name" Sortable="true" />
    <PropertyColumn Property="row => row.Role" Title="Role" Sortable="true" />
    <TemplateColumn Title="Active" Context="row">
        @(row.IsActive ? "Yes" : "No")
    </TemplateColumn>
    <TemplateColumn Title="Level 2" Context="row">
        @if (IsParentExpanded(row.Id))
        {
            var parentId = row.Id;
            <QuickGrid Items="GetSubRows(parentId)" Class="table table-sm mb-0 nested-grid">
                <TemplateColumn Title="" Context="subRow">
                    <button class="btn btn-sm btn-outline-secondary expand-btn" @onclick="() => ToggleChildTable(parentId, subRow.Id)">
                        @(IsChildExpanded(parentId, subRow.Id) ? "-" : "+")
                    </button>
                </TemplateColumn>
                <PropertyColumn Property="sub => sub.Id" Title="Sub ID" />
                <PropertyColumn Property="sub => sub.Component" Title="Component" />
                <PropertyColumn Property="sub => sub.Status" Title="Status" />
                <PropertyColumn Property="sub => sub.Owner" Title="Owner" />
                <TemplateColumn Title="Level 3" Context="subRow">
                    @if (IsChildExpanded(parentId, subRow.Id))
                    {
                        <QuickGrid Items="GetDetailRows(parentId, subRow.Id)" Class="table table-sm mb-0 nested-grid nested-grid-level-3">
                            <PropertyColumn Property="detail => detail.Id" Title="Detail ID" />
                            <PropertyColumn Property="detail => detail.Metric" Title="Metric" />
                            <PropertyColumn Property="detail => detail.Value" Title="Value" />
                            <PropertyColumn Property="detail => detail.UpdatedBy" Title="Updated By" />
                        </QuickGrid>
                    }
                </TemplateColumn>
            </QuickGrid>
        }
    </TemplateColumn>
</QuickGrid>

<Paginator State="Pagination" />

@code {
    private readonly PaginationState Pagination = new() { ItemsPerPage = 10 };
    private int? expandedParentId;
    private ChildRowKey? expandedChildKey;
    private static readonly string[] Roles = ["Admin", "Editor", "Viewer", "Reviewer"];
    private static readonly string[] Statuses = ["Healthy", "Warning", "Offline"];
    private static readonly string[] Owners = ["Alex", "Sam", "Taylor", "Jordan"];

    private static readonly IQueryable<TableRow> Rows = Enumerable.Range(1, 100)
        .Select(id => new TableRow(
            id,
            $"User {id:000}",
            Roles[(id - 1) % Roles.Length],
            id % 2 == 0))
        .AsQueryable();

    private IQueryable<TableSubRow> GetSubRows(int parentId) =>
        Enumerable.Range(1, 100)
            .Select(id => new TableSubRow(
                id,
                $"P{parentId:000}-Component-{id:000}",
                Statuses[(parentId + id) % Statuses.Length],
                Owners[(id - 1) % Owners.Length]))
            .AsQueryable();

    private IQueryable<TableDetailRow> GetDetailRows(int parentId, int childId) =>
        Enumerable.Range(1, 100)
            .Select(id => new TableDetailRow(
                id,
                $"P{parentId:000}-C{childId:000}-Metric-{id:000}",
                $"{((parentId * childId * id) % 100) + 1}%",
                Owners[(parentId + childId + id) % Owners.Length]))
            .AsQueryable();

    private void ToggleParentTable(int rowId)
    {
        expandedParentId = expandedParentId == rowId ? null : rowId;
        expandedChildKey = null;
    }

    private void ToggleChildTable(int parentId, int childId)
    {
        var key = new ChildRowKey(parentId, childId);
        expandedChildKey = expandedChildKey == key ? null : key;
    }

    private bool IsParentExpanded(int rowId) => expandedParentId == rowId;
    private bool IsChildExpanded(int parentId, int childId) => expandedChildKey == new ChildRowKey(parentId, childId);

    private sealed record ChildRowKey(int ParentId, int ChildId);

    private sealed record TableRow(int Id, string Name, string Role, bool IsActive);

    private sealed record TableSubRow(int Id, string Component, string Status, string Owner);

    private sealed record TableDetailRow(int Id, string Metric, string Value, string UpdatedBy);
}
